<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan lekcji</title>
    <style>
        .user-info {
            display: none;
        }
        #group-selection {
            display: none;
        }
        #plan-lekcji {
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <button id="google-sign-in">ZALOGUJ</button>
    <button id="sign-out" style="display: none;">WYLOGUJ</button>

    <div class="user-info">
        <img id="user-photo" src="" alt="Avatar">
        <p id="user-email"></p>
    </div>

    <div id="group-selection">
        <label for="group-number">Wybierz swoją grupę (1 lub 2):</label>
        <input type="number" id="group-number" min="1" max="2">
        <button id="set-group">Ustaw grupę</button>
    </div>

    <div id="plan-lekcji">
        <!-- Tutaj będzie wyświetlany plan lekcji -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBUqTro5SB7LlKQ67taNWIWcNVOUe59gJA",
            authDomain: "smartcampus-d4236.firebaseapp.com",
            projectId: "smartcampus-d4236",
            storageBucket: "smartcampus-d4236.firebasestorage.app",
            messagingSenderId: "783363629754",
            appId: "1:783363629754:web:d479a67a8a793553e11883",
            measurementId: "G-9NYEBXG23D"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Pobierz referencje do elementów HTML
        const googleSignInButton = document.getElementById('google-sign-in');
        const signOutButton = document.getElementById('sign-out');
        const userInfoDiv = document.querySelector('.user-info');
        const userPhoto = document.getElementById('user-photo');
        const userEmail = document.getElementById('user-email');
        const groupSelectionDiv = document.getElementById('group-selection');
        const groupNumberInput = document.getElementById('group-number');
        const setGroupButton = document.getElementById('set-group');
        const planLekcjiDiv = document.getElementById('plan-lekcji');

        // Funkcja aktualizująca UI w zależności od stanu zalogowania
        async function updateUI(user) {
            if (user) {
                // Zalogowany
                googleSignInButton.style.display = 'none';
                signOutButton.style.display = 'block';
                userInfoDiv.style.display = 'block';
                groupSelectionDiv.style.display = 'block'; // Pokaż wybór grupy

                userPhoto.src = user.photoURL;
                userEmail.textContent = user.email;

                // Pobierz dane użytkownika z Firestore
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    // Użytkownik istnieje w bazie danych
                    const userData = userSnap.data();
                    groupNumberInput.value = userData.grupa || ''; // Ustaw wartość inputu
                    wyswietlPlanLekcji(userData.grupa); // Wyświetl plan lekcji, jeśli grupa jest ustawiona
                }
            } else {
                // Wylogowany
                googleSignInButton.style.display = 'block';
                signOutButton.style.display = 'none';
                userInfoDiv.style.display = 'none';
                groupSelectionDiv.style.display = 'none'; // Ukryj wybór grupy
                planLekcjiDiv.innerHTML = ''; // Wyczyść plan lekcji

                userPhoto.src = "";
                userEmail.textContent = "";
            }
        }

        // Funkcja do wyświetlania planu lekcji
        async function wyswietlPlanLekcji(grupa) {
            if (!grupa) {
                planLekcjiDiv.innerHTML = "<p>Wybierz grupę, aby zobaczyć plan lekcji.</p>";
                return;
            }

            // Pobierz plan lekcji z Firestore
            const planRef = doc(db, "plan_lekcji", `grupa${grupa}`);
            const planSnap = await getDoc(planRef);

            if (planSnap.exists()) {
                const lekcja = planSnap.data();
                let planHTML = `<h3>Plan lekcji dla grupy ${grupa}</h3>`;
                planHTML += `<p><strong>Przedmiot:</strong> ${lekcja.Przedmiot}</p>`;
                planHTML += `<p><strong>Sala:</strong> ${lekcja.Sala}</p>`;
                planHTML += `<p><strong>Wykładowca:</strong> ${lekcja.Wykładowca}</p>`;
                planLekcjiDiv.innerHTML = planHTML;
            } else {
                planLekcjiDiv.innerHTML = "<p>Brak planu lekcji dla tej grupy.</p>";
            }
        }


        // Nasłuchuj na zmiany stanu autentykacji
        onAuthStateChanged(auth, async (user) => {
            await updateUI(user);
        });

        // Obsługa logowania
        googleSignInButton.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error('Błąd logowania:', error);
                });
        });

        // Obsługa wylogowania
        signOutButton.addEventListener('click', () => {
            signOut(auth)
                .catch((error) => {
                    console.error('Błąd wylogowania:', error);
                });
        });

        // Obsługa ustawiania grupy
        setGroupButton.addEventListener('click', async () => {
            const grupa = groupNumberInput.value;
            if (grupa === "1" || grupa === "2") {
                // Zapisz grupę w Firestore
                const user = auth.currentUser;
                if (user) {
                    const userRef = doc(db, "users", user.uid);
                    await setDoc(userRef, {
                        email: user.email,
                        grupa: grupa
                    }, { merge: true });

                    wyswietlPlanLekcji(grupa);
                }
            } else {
                alert("Wybierz grupę 1 lub 2.");
            }
        });
    </script>

</body>
</html>
